{% load static %}
<!doctype html>
<html lang="de">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Einstellungen – Subscribarr</title>
    <link rel="stylesheet" href="{% static 'css/settings.css' %}">
</head>

<body>
    <div class="wrap">
        <div class="topbar">
            <div><a href="/" class="btn">← Zurück</a></div>
            <div><strong>Einstellungen</strong></div>
            <div></div>
        </div>

        {% if messages %}
        <div class="msgs">{% for m in messages %}<div class="msg">{{ m }}</div>{% endfor %}</div>
        {% endif %}

        <form method="post">
            {% csrf_token %}
            <div class="grid">
                <div class="card">
                    <h2>Jellyfin</h2>
                    <div class="row">
                        <label>Jellyfin Server URL</label>
                        {{ jellyfin_form.jellyfin_server_url }}
                        <div class="help">z.B. http://localhost:8096</div>
                    </div>
                    <div class="row">
                        <label>Jellyfin API Key</label>
                        {{ jellyfin_form.jellyfin_api_key }}
                        <div class="help">Admin API Key aus den Jellyfin Einstellungen</div>
                    </div>
                </div>

                <div class="card">
                    <h2>Sonarr & Radarr</h2>

                    <div class="row">
                        <label>Sonarr URL</label>
                        <div class="inline">
                            <div class="field">{{ arr_form.sonarr_url }}</div>
                            <div class="inline-actions">
                                <button class="btn" type="button" onclick="testConnection('sonarr', this)">Test
                                    Sonarr</button>
                                <span id="sonarrStatus" class="badge muted">—</span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <label>Sonarr API Key</label>
                        {{ arr_form.sonarr_api_key }}
                    </div>


                    <div class="row">
                        <label>Radarr URL</label>
                        <div class="inline">
                            <div class="field">{{ arr_form.radarr_url }}</div>
                            <div class="inline-actions">
                                <button class="btn" type="button" onclick="testConnection('radarr', this)">Test
                                    Radarr</button>
                                <span id="radarrStatus" class="badge muted">—</span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <label>Radarr API Key</label>
                        {{ arr_form.radarr_api_key }}
                    </div>

                    <div class="help">Klicke „Test …“, um die Verbindung gegen <code>/api/v3/system/status</code> zu
                        prüfen.</div>
                </div>

                <div class="card">
                    <h2>Mailserver</h2>
                    <div class="row"><label>Host</label>{{ mail_form.mail_host }}</div>
                    <div class="row"><label>Port</label>{{ mail_form.mail_port }}</div>
                    <div class="row"><label>Sicherheit</label>{{ mail_form.mail_secure }}</div>
                    <div class="row"><label>Benutzer</label>{{ mail_form.mail_user }}</div>
                    <div class="row"><label>Passwort</label>{{ mail_form.mail_password }}</div>
                    <div class="row"><label>Absender</label>{{ mail_form.mail_from }}</div>
                </div>

                <div class="card">
                    <h2>Konto</h2>
                    <div class="row"><label>Benutzername</label>{{ account_form.username }}</div>
                    <div class="row"><label>E-Mail</label>{{ account_form.email }}</div>
                    <div class="row"><label>Neues Passwort</label>{{ account_form.new_password }}</div>
                    <div class="row"><label>Passwort wiederholen</label>{{ account_form.repeat_password }}</div>
                    <div class="help">Nur Oberfläche – Umsetzung Passwortänderung später.</div>
                </div>
            </div>

            <div style="margin-top:16px">
                <button class="btn btn-primary" type="submit">Speichern</button>
            </div>
        </form>
    </div>

    <script>

        function testConnection(kind) {
            const url = document.querySelector(`input[name="${kind}_url"]`).value;
            const key = document.querySelector(`input[name="${kind}_api_key"]`).value;

            fetch(`/settings/test-connection/?kind=${kind}&url=${encodeURIComponent(url)}&key=${encodeURIComponent(key)}`)
                .then(r => r.json())
                .then(data => {
                    if (data.ok) {
                        alert(kind + " Verbindung erfolgreich!");
                    } else {
                        alert(kind + " Fehler: " + data.error);
                    }
                })
                .catch(err => alert(kind + " Fehler: " + err));
        }

        function setBadge(kind, state, text, tooltip) {
            const el = document.getElementById(kind + "Status");
            if (!el) return;
            el.classList.remove("ok", "err", "muted");
            el.title = tooltip || "";               // voller Fehlertext im Tooltip
            if (state === "ok") {
                el.classList.add("ok");
                el.textContent = "Verbunden";
            } else if (state === "err") {
                el.classList.add("err");
                el.textContent = "Fehler";
            } else {
                el.classList.add("muted");
                el.textContent = "—";
            }
        }

        function testConnection(kind, btnEl) {
            const urlEl = document.querySelector(`input[name="${kind}_url"]`);
            const keyEl = document.querySelector(`input[name="${kind}_api_key"]`);
            const url = urlEl ? urlEl.value.trim() : "";
            const key = keyEl ? keyEl.value.trim() : "";

            setBadge(kind, "muted", "Teste…");
            if (btnEl) { btnEl.disabled = true; }

            fetch(`/settings/test-connection/?kind=${encodeURIComponent(kind)}&url=${encodeURIComponent(url)}&key=${encodeURIComponent(key)}`)
                .then(r => r.json())
                .then(data => {
                    if (data.ok) {
                        setBadge(kind, "ok", "Verbunden", "");
                    } else {
                        setBadge(kind, "err", "Fehler", data.error || "Unbekannter Fehler");
                    }
                })
                .catch(err => setBadge(kind, "err", "Fehler", String(err)))
                .finally(() => { if (btnEl) btnEl.disabled = false; });
        }

    </script>

</body>

</html>