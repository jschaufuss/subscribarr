{% extends "base.html" %}
{% load static %}
{% block title %}YouTube Subscriptions{% endblock %}
{% block extra_style %}
<link rel="stylesheet" href="{% static 'css/settings.css' %}">
<style>
.yt-fallback-icon {
  width: 64px;
  height: 64px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 24px;
}
.yt-channel {
  background: #cc2020;
}
.yt-playlist {
  background: #881818;
}
</style>
{% endblock %}
{% block content %}
<div class="wrap">
  <h1>YouTube</h1>
  <p class="muted">Subscribe to channels or playlists to get notified about new videos.</p>

  <div class="card" style="max-width:720px">
    <form method="post" action="{% url 'youtube:subscribe' %}" class="inline-form" id="yt-form">
      {% csrf_token %}
    </form>
    <div class="row">
      <label>Type</label>
      <select id="yt-kind" class="input-wide">
        <option value="channel">Channel</option>
        <option value="playlist">Playlist</option>
      </select>
    </div>
    <div class="row">
      <label>ID or URL</label>
      <input id="yt-id" class="input-wide" placeholder="https://www.youtube.com/@channel | UC... | PL...">
    </div>
    <div class="row">
      <label>Title (optional)</label>
      <input id="yt-title" class="input-wide" placeholder="Display name">
    </div>
  <div class="card-actions">
      <button class="btn btn-primary" id="yt-sub">Subscribe</button>
    </div>
  </div>

  <h2>Your subscriptions</h2>
  {% if sub_items %}
  <div class="subscription-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;">
    {% for it in sub_items %}
    {% with s=it.sub m=it.meta %}
    <div class="subscription-item" style="display:flex;gap:10px;background:rgba(0,0,0,.2);padding:10px;border-radius:10px;align-items:center;">
      {% if m.image %}
      <img src="{{ m.image }}" alt="thumb" style="width:64px;height:64px;object-fit:cover;border-radius:8px;background:#000">
      {% else %}
      <div class="yt-fallback-icon {% if s.kind == 'channel' %}yt-channel{% else %}yt-playlist{% endif %}">
        {% if s.kind == 'channel' %}ðŸ“º{% else %}ðŸ“‹{% endif %}
      </div>
      {% endif %}
      <div style="flex:1;min-width:0;">
        <div class="subscription-title" style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="{{ s.title }}">{{ m.title|default:s.title }}</div>
        <div class="subscription-date" style="font-size:.9rem;color:var(--muted)">{{ s.get_kind_display }} Â· {{ s.target_id }}</div>
        <div class="subscription-date" style="font-size:.9rem;color:var(--muted)">Subscribed on {{ s.created_at|date:"d.m.Y" }}</div>
      </div>
      <button class="btn" onclick="unsubscribeYT('{{ s.kind }}', '{{ s.target_id }}', this)">Unsubscribe</button>
    </div>
    {% endwith %}
    {% endfor %}
  </div>
  {% else %}
  <p class="muted">No YouTube subscriptions yet.</p>
  {% endif %}
</div>
<script>
(function(){
  function extractId(input){
    input = input.trim();
    if(!input) return '';
    try{
      if(input.startsWith('http')){
        const u = new URL(input);
        // channel URLs: /channel/UC..., /@handle, playlist URLs: list=PL...
        if(u.pathname.startsWith('/channel/')) return u.pathname.split('/')[2];
        const list = u.searchParams.get('list');
        if(list && (list.startsWith('PL')||list.startsWith('UU'))) return list;
        if(u.pathname.startsWith('/@')) return u.pathname; // keep handle; resolver can handle later
      }
    }catch(e){}
    return input;
  }
  const btn = document.getElementById('yt-sub');
  btn && btn.addEventListener('click', async ()=>{
    const kind = document.getElementById('yt-kind').value;
    const raw = document.getElementById('yt-id').value;
    const target_id = extractId(raw);
    const title = document.getElementById('yt-title').value;
    if(!target_id){ alert('Please enter a channel or playlist ID/URL'); return; }
    const fd = new FormData(); fd.append('kind', kind); fd.append('target_id', target_id); fd.append('title', title);
    const csrf = document.querySelector('#yt-form [name=csrfmiddlewaretoken]')?.value;
    const r = await fetch("{% url 'youtube:subscribe' %}", { method:'POST', body:fd, headers:{'X-CSRFToken': csrf} });
    const j = await r.json(); if(!j.ok) return alert(j.error||'Error'); location.reload();
  });

  window.unsubscribeYT = async function(kind, target_id, btn) {
    btn.disabled = true;
    btn.textContent = 'Removing...';
    try {
      const fd = new FormData();
      fd.append('kind', kind);
      fd.append('target_id', target_id);
      const csrf = document.querySelector('#yt-form [name=csrfmiddlewaretoken]')?.value;
      const r = await fetch("{% url 'youtube:unsubscribe' %}", { 
        method: 'POST', 
        body: fd, 
        headers: {'X-CSRFToken': csrf} 
      });
      const j = await r.json();
      if(!j.ok) {
        alert(j.error || 'Error unsubscribing');
        btn.disabled = false;
        btn.textContent = 'Unsubscribe';
        return;
      }
      // Remove the subscription item from the page
      btn.closest('.subscription-item').remove();
      // Check if no subscriptions left
      const remaining = document.querySelectorAll('.subscription-item').length;
      if (remaining === 0) {
        location.reload(); // Reload to show "No YouTube subscriptions yet" message
      }
    } catch(e) {
      alert('Error: ' + e.message);
      btn.disabled = false;
      btn.textContent = 'Unsubscribe';
    }
  };
})();
</script>
{% endblock %}
